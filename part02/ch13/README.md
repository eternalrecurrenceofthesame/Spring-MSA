# Resilience4j 를 사용해서 탄력성 개선하기
```
Resilience4j 를 사용해서 대규모 마이크로서비스 시스템에서 발생하는 느리거나 응답하지 않는 downstream 마이크로서비스로부터
오는 피해를 최소화 할 수 있으며 시간 초과, 재시도 메커니즘을 사용해서 빈번하게 발생하는 오류를 방지할 수 있다.
```
```
참고로 에지 서버에서는 Resilience4j 를 사용할 수 없다. 에지서버에 대한 지원을 추가한다는 소식이 있다.
spring.io/blog/2019/04/16/introducing-spring-cloud-circuit-breaker 참고 
```
## Resilience4j 의 서킷 브레이커와 재시도 메커니즘 소개

재시도와 서킷 브레이커 메커니즘은 마이크로서비스와 같은 동기 방식으로 연결되는 소프트웨어 컴포넌트에 특히 유용하다. 455 p 

### 서킷 브레이커 소개
```
서킷 브레이커는 다량의 오류 감지시 서킷을 열어 새 호출을 받지 않는다. 서킷이 열려있으면 폴백 메서드로
호출을 리디렉션한다.

폴백 메서드로 비즈니스로직을 구현해서 로컬 캐시의 데이터를 반환하거나 오류 메시지를 반환할 수 있다.

일정 시간이 지나면 서킷 브레이커는 반 열림 상태로 전환돼 새로운 호출을 허용한다. 이를 통해 문제를
일으킨 원인이 사라졌는지 확인하고 새로운 오류를 감지하면 다시 서킷을 열고 실패 로직을 수행한다.

오류가 사라졌다면 서킷을 닫고 정상 작동 상태로 돌아간다. 마이크로서비스는 이런 방법으로 문제에 대한
탄력성을 가지며 이는 동기 방식으로 통신하는 MSA 환경의 필수 기능이다. 457 p

서킷 브레이커의 현재 상태는 마이크로서비스의 액추에이터의 상태 점검 엔드포인트 (actuator/health) 를
사용해서 모니터링 할 수 있다.

서킷 브레이커는 상태 전이 등의 이벤트를 액추에이터 엔드포인트(/actuator/circuitbreakerevents) 에
게시한다.

서킷 브레이커는 스프링 부트의 메트릭 시스템과 통합돼 있으며, 이를 이용해 프로메테우스와 같은 모니터링
도구에 메트릭을 게시할 수 있다. 
```
### 재시도 메커니즘 소개
```
재시도는 일시적인 네트워크 결함과 같은 무작위로 드물게 발생하는 오류에 매우 유용하다. 재시도를 사용하기
위한 조건은 대상 서비스에 멱등성이 있어야 한다는 점이다.

같은 요청 매개 변수로 서비스를 여러번 호출하더라도 항상 같은 결과를 반환해야 한다 일반적으로 정보를 읽는
작업은 멱등성이 있지만 정보를 생성하는 작업에는 멱등성이 없다.

예를 들면 첫번째 주문을 생성한 후 네트워크 문제로 응답을 받지 못했더라도 재시도 매커니즘으로 인해 2 개의
주문이 생성되면 안 된다.

Res4j 는 서킷 브레이커와 같은 방식으로 재시도와 관련된 이벤트 및 메트릭 정보를 공개하지만 상태 정보는
제공하지 않고 이벤트에 관한 정보는 액추에이터 엔드포인트(/actuator/retryevents) 에서 얻을 수 있다.
```
```
(주의) 재시도 및 서킷 브레이커 설정을 구성할 때 의도한 재시도 횟수가 완료되기 전에 서킷 브레이커가 서킷을
열게 하면 안 된다.
```
## 서킷 브레이커 및 재시도 메커니즘 추가하기 

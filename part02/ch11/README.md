# API 접근 보안

에지 서버를 통해 공개되는 복합 마이크로서비스, 유레카 API 및 웹 페이지(유레카 서버)에 대한 접근을 보호하기 

## OAuth 2.0 및 OpenID Connect 소개
```
* 용어 정리

인증: 사용자 이름과 암호 같은 사용자가 제공하는 자격 증명을 확인해 사용자를 식별하는 것
권한 부여: 식별된 사용자에게 API 에 대한 접근 권한을 부여 (ex OAuth 2.0 스코프)
OAuth 2.0: 권한 부여를 위한 공개 표준

OpenID Connect: 클라이언트 애플리케이션이 권한 부여 서버에서 받은 자격 증명을 기반으로 사용자의 신원을 확인할 수
있도록 OAuth 2.0 에 추가된 기능
```
### OAuth 2.0 소개
```
OAuth 2.0 는 서드파티 클라이언트 애플리케이션(웹 클라이언트) 가 사용자를 대신해 보안 리소스에 접근할 수 있게 해준다. 
```
```
* 개념 정리

자원 소유자 resource owner: 최종 사용자. (유저)
클라이언트 client: 최종 사용자의 권한을 위임 받아 보안 API 를 호출하는 서브파티 애플리케이션(웹 앱, 네이티브  모바일 앱)
자원 서버 resource server: 보호 대상 자원에 대한 API 를 제공하는 서버 (게이트 웨이 -> 유레카, 복합 마이크로서비스)

권한 부여 서버 authorization server: 자원 소유자를 인증하고 자원 소유자의 승인을 바다서 *클라이언트* 에게 토큰을 발급한다.
사용자 정보 관리 및 사용자 인증은 보통 ID 제공자에게 위임된다.
```
```
* 권한 부여 서버를 사용해서 권한을 부여 받는 전체적인 흐름

사용자 -> 클라이언트(웹 앱) -> API 접근 요청 클라이언트는 리소스에 접근하기 위해 권한 부여 서버에서 권한을 부여받아야 한다.
사용자의 자격 증명을 클라이언트 와 공유하지 않기 위해 권한 부여 서버에서는 클라이언트에 토큰을 발급한다. 

클라이언트는 이 토큰으로 승인된 API 에 접근할 수 있다. 토큰 시간에는 제한이 있고 OAuth 2.0 스코프를 사용해서 접근 권한을 제한한다. 
권한 부여 서버는 클라이언트 애플리케이션에 재발급 토큰을 발급할 수 있다. 

https://github.com/eternalrecurrenceofthesame/Spring-security-in-Action/tree/main/ch12
토큰을 부여받는 각 그랜트 유형은 위 링크를 참고한다.

https://datatracker.ietf.org/doc/html/rfc6749
https://www.oauth.com/oauth2-servers/map-oauth-2-0-specs/ 
OAuth 2 전체 사양 정보
```
### OpenID Connect 소개
```
OIDC 는 클라이언트 애플리케이션이 사용자의 신원을 확인하게 하려고 OAuth 2.0 에 추가된 기능이다. 

OIDC 를 사용하면 승인 흐름이 완료된 후 클라이언트 애플리케이션이 권한 부여 서버에서 받아오는 토큰인 ID 토큰(JWT 인코딩) 이 
추가되고 사용자 ID 이메일 주소와 같은 다수의 클레임을 포함한다. 
(ID token 과 같은 방식으로 접근 토큰을 인코딩하고 서명할 수 있다 필수는 아님.)


OIDC 는 디스커버리 엔드포인트를 정의해서 주요 엔드포인트에 대한 정보를 제공한다. 주요 엔드포인트로

JWKS 엔드포인트 (JWK 란 서명된 JWT 토큰을 확인할 때 필요한 공개키를 의미한다.)
권한 부여 엔드포인트
사용자 정보 엔드포인트 가 있다 387 p

more info ODIC - openid.net/developers/specs
```
## 시스템 환경 보안 구현하기
```
HTTPS 를 사용해서 공개된 API 에 대한 외부 요청과 응답을 암호화 하여 도청을 방지한다.
OAuth 2.0 + OIDC 를 사용해서 API 에 접근하는 클라이언트에 인증 및 권한 부여를 수행한다.
HTTP 기본 인증을 사용해 검색 서비스(유레카) 에 대한 접근을 보호한다.

외부 통신은 https 로 보호하고 시스템 환경에서는 http 를 사용해서 통신한다.
```
### 권한 부여 서버 추가하기
```
OAuth 2.0 및 OIDC 기반의 보안 API 로 로컬 테스트 및 완전히 자동화된 테스트를 실행하고자 OAuth 2.0 기반의 권한 부여 서버를 
직접 구현해본다.

sprin-cloud authorization-server  참고

config: AuthServerConfig(Auth 2.0 설정 정보) , DefaultSecurityConfig(시큐리티 기본 설정)
jose: keygenerateutils 클래스를 사용해서 (jwk 서명 키)를 생성한다. 
```
## HTTPS 를 사용한 외부 통신 보호
```
* HTTPS 를 사용해서 통신을 암호화 하기 위한 준비

HTTPS 인증서 생성: 개발 목적의 자체 인증서 생성
에지서버 구성: 인증서를 사용해 HTTPS 기반 외부 트래픽만 허용하도록 에지 서버를 구성 

생성된 인증서 파일은 gateway resources keystore 참고한다
프로젝트 빌드시 .jar 파일에 포함시킬 수 있고 런타임시 keystore/dege.p12 클래스패스로 접근할 수 있다.
```
```
* 인증서를 사용하기 위한 에지서버 설정

gateway yml, docker-compose 참고
```










